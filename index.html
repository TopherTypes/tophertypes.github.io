<!DOCTYPE html>
<html>
  <head>
    <title>Drive API Smoke Test (appDataFolder)</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Drive API Smoke Test (appDataFolder)</p>

    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <button onclick="initNotes()">Init notes.json</button>
<button onclick="loadNotes()">Load notes.json</button>
<button onclick="saveNotes()">Save notes.json (test write)</button>


    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script>
      /* exported gapiLoaded */
      /* exported gisLoaded */
      /* exported handleAuthClick */
      /* exported handleSignoutClick */

      // TODO: paste these from Google Cloud Console
      const CLIENT_ID = "15768027919-fs339ovijr4ueh0hkn77974bmbq8d9m1.apps.googleusercontent.com";
      const API_KEY = "AIzaSyCxjOFISZK_OMVHN22OSdLf5CaLAeC9yDk";

      // Drive API discovery doc
      const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";

      // Minimal scope for hidden app data folder
      const SCOPES = "https://www.googleapis.com/auth/drive.appdata";

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById("authorize_button").style.visibility = "hidden";
      document.getElementById("signout_button").style.visibility = "hidden";

      function append(text) {
        const content = document.getElementById("content");
        content.textContent += text + "\n";
      }

      async function listAppDataFiles() {
        append("Listing files in appDataFolder...");
        const res = await gapi.client.drive.files.list({
          spaces: "appDataFolder",
          fields: "files(id, name, modifiedTime, size)"
        });

        const files = res.result.files || [];
        if (!files.length) {
          append("No files found in appDataFolder (this is fine for first run).");
          return;
        }

        append(`Found ${files.length} file(s):`);
        for (const f of files) {
          append(`- ${f.name} (id=${f.id}, modified=${f.modifiedTime})`);
        }
      }

      function gapiLoaded() {
        gapi.load("client", async () => {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
          });
          gapiInited = true;
          maybeEnableButtons();
        });
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: "", // set later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById("authorize_button").style.visibility = "visible";
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById("signout_button").style.visibility = "visible";
          document.getElementById("authorize_button").textContent = "Re-authorize";
          document.getElementById("content").textContent = "";
          await listAppDataFiles();
        };

        // Prompt for consent the first time; silent refresh after
        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({ prompt: "consent" });
        } else {
          tokenClient.requestAccessToken({ prompt: "" });
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          document.getElementById("content").textContent = "";
          document.getElementById("authorize_button").textContent = "Authorize";
          document.getElementById("signout_button").style.visibility = "hidden";
        }
      }
    </script>

    <script>
  const NOTES_FILENAME = "meeting-notes.v1.json";

  async function findNotesFileId() {
    const res = await gapi.client.drive.files.list({
      spaces: "appDataFolder",
      q: `name='${NOTES_FILENAME.replace(/'/g, "\\'")}' and trashed=false`,
      fields: "files(id, name, modifiedTime)",
      pageSize: 10
    });
    const files = res.result.files || [];
    return files.length ? files[0].id : null;
  }

  async function createNotesFile(initialJson) {
    // Create file metadata in appDataFolder
    const metadata = {
      name: NOTES_FILENAME,
      parents: ["appDataFolder"],
      mimeType: "application/json"
    };

    const boundary = "-------314159265358979323846";
    const delimiter = "\r\n--" + boundary + "\r\n";
    const closeDelim = "\r\n--" + boundary + "--";

    const multipartRequestBody =
      delimiter +
      "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
      JSON.stringify(metadata) +
      delimiter +
      "Content-Type: application/json\r\n\r\n" +
      JSON.stringify(initialJson) +
      closeDelim;

    const res = await gapi.client.request({
      path: "/upload/drive/v3/files?uploadType=multipart&fields=id,name,modifiedTime",
      method: "POST",
      headers: { "Content-Type": 'multipart/related; boundary="' + boundary + '"' },
      body: multipartRequestBody
    });

    return res.result.id;
  }

  async function downloadNotesJson(fileId) {
    const res = await gapi.client.request({
      path: `/drive/v3/files/${fileId}`,
      method: "GET",
      params: { alt: "media" }
    });
    // gapi returns parsed JSON if response is JSON, otherwise text
    return res.body ? JSON.parse(res.body) : res.result;
  }

  async function uploadNotesJson(fileId, jsonObj) {
    const res = await gapi.client.request({
      path: `/upload/drive/v3/files/${fileId}`,
      method: "PATCH",
      params: { uploadType: "media" },
      headers: { "Content-Type": "application/json; charset=UTF-8" },
      body: JSON.stringify(jsonObj)
    });
    return res;
  }

  async function ensureNotesFile() {
    let fileId = await findNotesFileId();
    if (!fileId) {
      append("notes file not found; creating in appDataFolder...");
      const initial = makeEmptyDb();
      fileId = await createNotesFile(initial);
      append(`created ${NOTES_FILENAME} (id=${fileId})`);
    } else {
      append(`found ${NOTES_FILENAME} (id=${fileId})`);
    }
    return fileId;
  }

  function makeEmptyDb() {
    return {
      schemaVersion: 1,
      updatedAt: new Date().toISOString(),
      people: [],
      groups: [],
      topics: [],
      meetings: [],
      items: []
    };
  }
</script>

    <script>
  let notesFileId = null;
  let cachedDb = null;

  async function initNotes() {
    document.getElementById("content").textContent = "";
    notesFileId = await ensureNotesFile();
  }

  async function loadNotes() {
    document.getElementById("content").textContent = "";
    notesFileId = notesFileId || (await ensureNotesFile());
    cachedDb = await downloadNotesJson(notesFileId);
    append("Loaded DB:");
    append(JSON.stringify(cachedDb, null, 2));
  }

  async function saveNotes() {
    document.getElementById("content").textContent = "";
    notesFileId = notesFileId || (await ensureNotesFile());
    cachedDb = cachedDb || makeEmptyDb();

    // test write: update timestamp + write a tiny marker record
    cachedDb.updatedAt = new Date().toISOString();
    cachedDb._lastTestWrite = cachedDb.updatedAt;

    await uploadNotesJson(notesFileId, cachedDb);
    append("Saved DB to Drive (appDataFolder). Now reload to confirm.");
  }
</script>



    <!-- Google API client library -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <!-- Google Identity Services -->
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>


