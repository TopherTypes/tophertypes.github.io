<!DOCTYPE html>
<html>
  <head>
    <title>Drive API Smoke Test (appDataFolder)</title>
    <meta charset="utf-8" />
  </head>
  <body>
    <p>Drive API Smoke Test (appDataFolder)</p>

    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>

    <pre id="content" style="white-space: pre-wrap;"></pre>

    <script>
      /* exported gapiLoaded */
      /* exported gisLoaded */
      /* exported handleAuthClick */
      /* exported handleSignoutClick */

      // TODO: paste these from Google Cloud Console
      const CLIENT_ID = "PASTE_YOUR_OAUTH_CLIENT_ID_HERE";
      const API_KEY = "PASTE_YOUR_API_KEY_HERE";

      // Drive API discovery doc
      const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";

      // Minimal scope for hidden app data folder
      const SCOPES = "https://www.googleapis.com/auth/drive.appdata";

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      document.getElementById("authorize_button").style.visibility = "hidden";
      document.getElementById("signout_button").style.visibility = "hidden";

      function append(text) {
        const content = document.getElementById("content");
        content.textContent += text + "\n";
      }

      async function listAppDataFiles() {
        append("Listing files in appDataFolder...");
        const res = await gapi.client.drive.files.list({
          spaces: "appDataFolder",
          fields: "files(id, name, modifiedTime, size)"
        });

        const files = res.result.files || [];
        if (!files.length) {
          append("No files found in appDataFolder (this is fine for first run).");
          return;
        }

        append(`Found ${files.length} file(s):`);
        for (const f of files) {
          append(`- ${f.name} (id=${f.id}, modified=${f.modifiedTime})`);
        }
      }

      function gapiLoaded() {
        gapi.load("client", async () => {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
          });
          gapiInited = true;
          maybeEnableButtons();
        });
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: "", // set later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById("authorize_button").style.visibility = "visible";
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw resp;
          }
          document.getElementById("signout_button").style.visibility = "visible";
          document.getElementById("authorize_button").textContent = "Re-authorize";
          document.getElementById("content").textContent = "";
          await listAppDataFiles();
        };

        // Prompt for consent the first time; silent refresh after
        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({ prompt: "consent" });
        } else {
          tokenClient.requestAccessToken({ prompt: "" });
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken("");
          document.getElementById("content").textContent = "";
          document.getElementById("authorize_button").textContent = "Authorize";
          document.getElementById("signout_button").style.visibility = "hidden";
        }
      }
    </script>

    <!-- Google API client library -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>

    <!-- Google Identity Services -->
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
